# GitHub CI build pipeline
name: Containerapp Preview Extension CI build

on:
  push:
    branches:
      - containerapp-preview
    paths:
      - src/containerapp-preview/**
      - .github/workflows/build.yml
  pull_request:
    branches:
      - containerapp-preview
    paths:
      - src/containerapp-preview/**

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.6"
          - python-version: "3.7"
          - python-version: "3.8"
          - python-version: "3.9"
          - python-version: "3.10"
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create Virtual Environment
        run: |
          python -m venv env

      - name: Install requirements
        run: |
          source env/bin/activate
          pip install -U pip
          pip install -U pylint
          pip install -U flake8
          pip install -U autopep8
          pip install -U azdev
          pip install -U pycomposefile

      - name: Setup Azure CLI Dev Tooling
        run: |
          source env/bin/activate
          azdev setup --repo '.'
          azdev extension add containerapp-preview

      - name: Style
        run: |
          source env/bin/activate
          azdev style containerapp-preview

      # - name: Lint
      #   if: success() || failure()
      #   run: |
      #     source env/bin/activate
      #     azdev linter containerapp-preview

      - name: Functional Tests
        if: success() || failure()
        run: |
          source env/bin/activate
          azdev test containerapp-preview

  build:
    needs: test
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/containerapp-preview' }}
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"

      - name: Create Virtual Environment
        run: |
          python -m venv env

      - name: Install requirements
        run: |
          source env/bin/activate
          pip install -U pip
          pip install -U azdev

      - name: Run package creation
        run: |
          source env/bin/activate
          azdev setup --repo '.'
          azdev extension build containerapp-preview

      - name: Upload extension
        uses: actions/upload-artifact@v3
        with:
          name: containerapp-preview-extension
          path: dist/containerapp_preview-?.?.?-py2.py3-none-any.whl

  integration_tests:
    needs: build
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/containerapp-preview' }}
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP: containerapp-preview-ci
      ENVIRONMENT_NAME: containerapppreviewci
      TAG: main
    steps:
      - name: Checkout examples repo
        uses: actions/checkout@v3
        with:
          repository: smurawski/docker-compose-examples
          path: examples
      - uses: actions/download-artifact@v3
        with:
          name: containerapp-preview-extension
          path: .
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Add extension
        run: |
          az extension add --source ./*.whl --yes
      - name: Extension Help
        run: |
          az containerapp compose --help
          az containerapp compose create --help
      - name: Create resource group
        run: |
          az group create --name $RESOURCE_GROUP --location eastus

      - name: Simple Example
        run: |
          cd examples/simple

          URL=$(az containerapp compose create \
            --environment $ENVIRONMENT_NAME \
            --resource-group $RESOURCE_GROUP \
            --query '[].properties.configuration.ingress.fqdn' \
            --only-show-errors \
            -o tsv)

          curl https://$URL

      - name: GRPC Example
        run: |
          cd examples/grpc

          URL=$(az containerapp compose create \
          --environment $ENVIRONMENT_NAME \
          --resource-group $RESOURCE_GROUP \
          --transport backend=http2 \
          --query '[?name==`frontend`].properties.configuration.ingress.fqdn' \
          --only-show-errors \
          -o tsv)
          curl https://$URL/hello

      - name: Cleanup Resource Group
        run: |
          az group delete --name $RESOURCE_GROUP --yes

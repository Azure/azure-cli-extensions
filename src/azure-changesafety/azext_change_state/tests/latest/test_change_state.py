# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

from types import SimpleNamespace

import pytest
from azure.cli.testsdk import *

from azext_change_state.custom import (
    ChangeStateCreate,
    ChangeStateUpdate,
    _inject_change_definition_into_content,
    _inject_targets_into_result,
    _normalize_targets_arg,
)
from azure.cli.core.azclierror import InvalidArgumentValueError
from azure.cli.core.aaz._arg_action import AAZArgActionOperations, _ELEMENT_APPEND_KEY


class ChangeStateScenario(ScenarioTest):
    def test_normalize_targets_from_operations(self):
        operations = AAZArgActionOperations.__new__(AAZArgActionOperations)
        operations._ops = [
            ((_ELEMENT_APPEND_KEY,), "env=prod"),
            ((0, "resourceId"), "/subscriptions/000/resourceGroups/rg/providers/Microsoft.Web/sites/app"),
            ((0, "operation"), "delete"),
            ((1,), "subscriptionId=00000000-0000-0000-0000-000000000000"),
        ]

        normalized = _normalize_targets_arg(operations)

        assert normalized == [
            "env=prod,resourceId=/subscriptions/000/resourceGroups/rg/providers/Microsoft.Web/sites/app,operation=delete",
            "subscriptionId=00000000-0000-0000-0000-000000000000",
        ]

    def test_normalize_targets_from_serializable_value(self):
        class DummySerializable:
            def to_serialized_data(self):
                return ["rg=my-rg", None, "", "operation=show"]

        normalized = _normalize_targets_arg(DummySerializable())

        assert normalized == ["rg=my-rg", "operation=show"]

    def test_normalize_targets_from_list_of_strings(self):
        raw_targets = [" resourceId=/foo ", "", "operation=PUT", None]

        normalized = _normalize_targets_arg(raw_targets)

        assert normalized == ["resourceId=/foo", "operation=PUT"]

    def test_normalize_targets_with_none_returns_empty(self):
        assert _normalize_targets_arg(None) == []

    def test_inject_change_definition_into_content_adds_properties(self):
        ctx = _dummy_ctx_with_change_definition({"details": {"targets": []}})
        content = {"properties": {"existing": "value"}}

        result = _inject_change_definition_into_content(content, ctx)

        assert result["properties"]["existing"] == "value"
        assert result["properties"]["changeDefinition"] == {"details": {"targets": []}}

    def test_inject_change_definition_with_empty_payload_noop(self):
        ctx = _dummy_ctx_with_change_definition({})
        original = {"properties": {"foo": "bar"}}

        result = _inject_change_definition_into_content(original.copy(), ctx)

        assert result == original

    def test_inject_targets_into_result_updates_nested_properties(self):
        data = {"properties": {"changeDefinition": {"details": {}}}}
        targets = [{"resourceId": "/foo"}]

        _inject_targets_into_result(data, targets)

        assert data["properties"]["changeDefinition"]["details"]["targets"] == targets

    def test_inject_targets_does_not_override_existing(self):
        existing = [{"resourceId": "/existing"}]
        data = {"changeDefinition": {"details": {"targets": existing.copy()}}}
        new_targets = [{"resourceId": "/new"}]

        _inject_targets_into_result(data, new_targets)

        assert data["changeDefinition"]["details"]["targets"] == existing


def _dummy_ctx_with_change_definition(payload):
    dummy = SimpleNamespace()
    dummy.to_serialized_data = lambda: payload
    return SimpleNamespace(vars=SimpleNamespace(change_definition=dummy))

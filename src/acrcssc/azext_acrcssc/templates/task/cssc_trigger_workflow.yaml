version: v1.1.0
alias:
  values:
    ScanImageAndSchedulePatchTask: cssc-scan-image
    cssc : mcr.microsoft.com/acr/cssc:56f0765
steps:
  - cmd: bash -c 'echo "Inside cssc-trigger-workflow task, getting list of images to be patched based on --filter-policy for Registry {{.Run.Registry}}."'
  - cmd: cssc acr cssc patch --filter-policy csscpolicies/patchpolicy:v1 --dry-run > filterRepos.txt
    env:
      - ACR_EXPERIMENTAL_CSSC=true
  - cmd: bash -c 'sed -n "/^Listing/,/^Total/ {/^Listing/b;/^Total/b;p}" filterRepos.txt' > filterReposToDisplay.txt
  - cmd: bash -c 'echo -e "Below images will be scanned and patched (if any os vulnerabilities found) based on --filter-policy.\n$(cat filterReposToDisplay.txt)"'
  - cmd: cssc acr cssc patch --filter-policy csscpolicies/patchpolicy:v1 --show-patch-tags --dry-run> filterReposWithPatchTags.txt
    env:
      - ACR_EXPERIMENTAL_CSSC=true
  - cmd: bash -c 'sed -n "/^Listing/,/^Total/ {/^Listing/b;/^Total/b;p}" filterReposWithPatchTags.txt' > filteredReposAndTags.txt
  - cmd: az login --identity 
  - cmd: |
        az -c 'while read line;do \
        RegistryName="${line%%/*}"; \
        Rest="${line#*/}"; \
        IFS=':' read -r -a array2 <<< "${Rest}"
        IFS=',' read -r -a array3 <<< "${array2[1]}"
        RepoName=${array2[0]};
        OriginalTag=${array3[0]};
        TagName=${array3[1]};
        echo "Scheduling $ScanImageAndSchedulePatchTask for $RegistryName/$RepoName, Tag:$TagName, OriginalTag:$OriginalTag";
        az acr task run --name $ScanImageAndSchedulePatchTask --registry $RegistryName --set SOURCE_REPOSITORY=$RepoName --set SOURCE_IMAGE_TAG=$TagName --set SOURCE_IMAGE_ORIGINAL_TAG=$OriginalTag --no-wait; \
        done < filteredReposAndTags.txt;'
    entryPoint: /bin/bash
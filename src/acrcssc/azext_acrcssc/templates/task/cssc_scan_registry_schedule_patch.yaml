version: v1.1.0
alias:
  values:
    ScanRepoAndSchedulePatchTask: cssc-scan-repository-schedule-patch
steps:
  - cmd: bash -c 'echo "Scaning Repo {{.Values.SOURCE_REPOSITORY}}"'
  - cmd: az login --identity
  - cmd: mcr.microsoft.com/azure-cli az acr repository list -n $RegistryName --debug > repos.json
  - cmd: mcr.microsoft.com/azure-cli jq -r .[] repos.json > repos.txt
  - cmd: |
        mcr.microsoft.com/azure-cli bash -c 'while read line;do \
        echo "Processing repo $line"; \
        az acr task run --name $ScanRepoAndSchedulePatchTask --debug --registry $RegistryName --set SOURCE_REPOSITORY=$line --no-wait; \
        done < repos.txt;'
version: v1.1.0
alias:
  values:
    patchimagetask: cssc-patch-image
steps:
  - id: print-inputs
    cmd: |
        bash -c 'echo "Scaning image for vulnerability and patch {{.Values.SOURCE_REPOSITORY}}:{{.Values.SOURCE_IMAGE_TAG}} for tag {{.Values.SOURCE_IMAGE_ORIGINAL_TAG}}"'
  - id: setup-data-dir
    cmd: bash mkdir ./data

  - id: generate-trivy-report
    cmd: |
      ghcr.io/aquasecurity/trivy image \
      {{.Run.Registry}}/{{.Values.SOURCE_REPOSITORY}}:{{.Values.SOURCE_IMAGE_TAG}} \
      --vuln-type os \
      --ignore-unfixed \
      --format json \
      --output /workspace/data/vulnerability-report_trivy_{{now | date "2023-01-02"}}.json
  - cmd: mcr.microsoft.com/azure-cli bash -c 'jq "[.Results[].Vulnerabilities | length] | add" /workspace/data/vulnerability-report_trivy_{{now | date "2023-01-02"}}.json > /workspace/data/vulCount.txt'
  - cmd: az login --identity
  - cmd: bash echo "$(cat /workspace/data/vulCount.txt)"
  - cmd: | 
      mcr.microsoft.com/azure-cli bash -c 'vulCount=$(cat /workspace/data/vulCount.txt) && \
      [ $vulCount -gt 0 ] && \
      az acr task run --name $patchimagetask --registry $RegistryName --set SOURCE_REPOSITORY={{.Values.SOURCE_REPOSITORY}} --set SOURCE_IMAGE_TAG={{.Values.SOURCE_IMAGE_ORIGINAL_TAG}} --no-wait \
      || echo "No vulnerability in the image {{.Values.SOURCE_REPOSITORY}}:{{.Values.SOURCE_IMAGE_TAG}}"'
# --------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for
# license information.
#
# Code generated by Microsoft (R) AutoRest Code Generator.
# Changes may cause incorrect behavior and will be lost if the code is
# regenerated.
# --------------------------------------------------------------------------
import re
import yaml
import pytest
from azext_mlv2.tests.scenario_test_helper import MLBaseScenarioTest


class VirtualClusterScenarioTest(MLBaseScenarioTest):
    
    @pytest.mark.private_preview_only
    def test_virtual_cluster(self) -> None:
        vc_list_obj = self.cmd("az ml virtualcluster list")

        vc_list = yaml.safe_load(vc_list_obj.output)
        assert len(vc_list) > 0
                
        test_vc_name = "SingularityTestVC"
        singularity_test_vc = [vc for vc in vc_list if vc["name"] == test_vc_name][0]

        REGEX_PATTERN = (
            "^/?subscriptions/([^/]+)/resourceGroups/([^/]+)/providers/Microsoft.MachineLearningServices/virtualclusters/([^/]+)"
        )
        match = re.match(REGEX_PATTERN, singularity_test_vc["id"])
        subscription_id = match.group(1)
        resource_group_name = match.group(2)
        vc_name = match.group(3)

        self.cmd(f"az account set -s {subscription_id}")
        vc_obj = self.cmd(f"az ml virtualcluster show -n {vc_name} -g {resource_group_name}").output
        vc = yaml.safe_load(vc_obj)
        assert test_vc_name == vc["name"]
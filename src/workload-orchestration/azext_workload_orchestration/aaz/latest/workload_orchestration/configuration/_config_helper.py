# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

# pylint: skip-file
# flake8: noqa

from azure.cli.core.aaz import *


class ConfigurationHelper:
    """Helper class for workload orchestration configuration operations"""
    
    def __init__(self):
        """Initialize the configuration helper"""
        pass
    
    @staticmethod
    def getConfigurationId(hierarchy_id, client):
        """
        Get configuration ID from hierarchy ID by calling configuration reference API
        
        Args:
            hierarchy_id (str): The hierarchy ID (ARM ID of site or target)
            client: HTTP client for making the request
            
        Returns:
            str: The configuration ID from configurationResourceId field
            
        Raises:
            CLIInternalError: If configuration reference is not found or configuration doesn't exist
        """
        from azure.cli.core.azclierror import CLIInternalError
        import json
        
        # Convert hierarchy_id to string if it's an AAZ type
        hierarchy_id_str = str(hierarchy_id) if hierarchy_id else ""
        
        def try_get_config_id(lookup_id, api_version = "2025-08-01"):
            """Helper function to try getting configuration ID for a given lookup ID"""
            config_ref_url = client.format_url(
                "{hierarchyId}/providers/Microsoft.Edge/configurationreferences/default",
                hierarchyId=lookup_id
            )
            
            request = client._request("GET", config_ref_url, {
                "api-version": api_version
            }, {
                "Accept": "application/json"
            }, None, {}, None)
            
            response = client.send_request(request=request, stream=False)
            
            if response.http_response.status_code != 200:
                return None
            
            response_text = response.http_response.text()
            data = json.loads(response_text)
            configuration_id = data.get("properties", {}).get("configurationResourceId")
            
            if not configuration_id:
                return None
            
            # Verify the configuration exists
            config_url = client.format_url(
                "{configurationId}",
                configurationId=configuration_id
            )
            config_request = client._request("GET", config_url, {
                "api-version": "2025-08-01"
            }, {
                "Accept": "application/json"
            }, None, {}, None)
            
            config_response = client.send_request(request=config_request, stream=False)
            
            if config_response.http_response.status_code == 200:
                return configuration_id
            
            return None
        
        # Check if hierarchy_id is a service group-based site ID
        service_group_id = None
        if "/providers/Microsoft.Management/serviceGroups/" in hierarchy_id_str and "/providers/Microsoft.Edge/sites/" in hierarchy_id_str:
            # Extract service group ID: everything before /providers/Microsoft.Edge/sites/
            parts = hierarchy_id_str.split("/providers/Microsoft.Edge/sites/")
            if len(parts) == 2:
                service_group_id = parts[0]
        
        # Try with service group ID if it's a service group-based site
        if service_group_id:
            # Try with the original hierarchy_id first
            try:
                configuration_id = try_get_config_id(hierarchy_id_str, "2025-06-01")
                if configuration_id:
                    return configuration_id
            except Exception:
                pass
            try:
                configuration_id = try_get_config_id(service_group_id)
                if configuration_id:
                    return configuration_id
            except Exception:
                pass
        else:
            try:
                configuration_id = try_get_config_id(hierarchy_id_str)
                if configuration_id:
                    return configuration_id
            except Exception:
                pass

        
        # If we reach here, no configuration was found
        raise CLIInternalError(f"No configuration linked to this hierarchy: {hierarchy_id_str}")
    
    @staticmethod
    def getTemplateUniqueIdentifier(subscription_id, template_resource_group_name, template_name, solution_flag, client):
        """
        Get template unique identifier from template ID
        
        Args:
            subscription_id (str): The subscription ID for the template
            template_resource_group_name (str): The resource group name for the template
            template_name (str): The template name
            solution_flag (bool): True for solution template, False for configuration template
            client: HTTP client for making the request
            
        Returns:
            str: The unique identifier from template properties or template name as fallback
            
        Raises:
            CLIInternalError: If template doesn't exist
        """
        from azure.cli.core.azclierror import CLIInternalError
        
        # Build template ID based on solution flag
        if solution_flag:
            template_type = "solutionTemplates"
        else:
            template_type = "configTemplates"
        
        template_id = f"/subscriptions/{subscription_id}/resourceGroups/{template_resource_group_name}/providers/Microsoft.Edge/{template_type}/{template_name}"
        
        try:
            # Make GET request to template using client.format_url
            template_url = client.format_url(
                "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Edge/{templateType}/{templateName}",
                subscriptionId=subscription_id,
                resourceGroupName=template_resource_group_name,
                templateType=template_type,
                templateName=template_name
            )
            request = client._request("GET", template_url, {
                "api-version": "2025-08-01"
            }, {
                "Accept": "application/json"
            }, None, {}, None) 
            
            response = client.send_request(request=request, stream=False)
            
            if response.http_response.status_code == 404:
                raise CLIInternalError(f"Template doesn't exist with template ID: {template_id}")
            elif response.http_response.status_code != 200:
                raise CLIInternalError(f"Failed to get template with ID: {template_id}")
            
            # Parse JSON response
            import json
            response_text = response.http_response.text()
            data = json.loads(response_text)
            
            unique_identifier = data.get("properties", {}).get("uniqueIdentifier")
            
            # Return unique identifier if it exists and is not empty, otherwise return template name
            if unique_identifier and unique_identifier.strip():
                return unique_identifier
            else:
                return template_name
                
        except CLIInternalError:
            # Re-raise CLI errors as-is
            raise
        except Exception as e:
            raise CLIInternalError(f"Error getting template unique identifier for template {template_id}: {str(e)}")

    @staticmethod
    def getTemplateSchema(subscription_id, resource_group, template_name, version, solution_flag, client):
        """
        Get template schema
        
        Args:
            subscription_id (str): The subscription ID for the template
            resource_group (str): The resource group name for the template  
            template_name (str): The template name
            version (str): The template version
            solution_flag (bool): True for solution template, False for configuration template
            client: HTTP client for making the request
            
        Returns:
            str: Raw schema YAML string from the template
            
        Raises:
            CLIInternalError: If schema doesn't exist or request fails
        """
        from azure.cli.core.azclierror import CLIInternalError
        
        # Build template version ID
        if solution_flag:
            template_type = "solutionTemplates"
            schema_endpoint = "solutionSchemas/default"
        else:
            template_type = "configTemplates" 
            schema_endpoint = "configTemplateSchemas/default"
        
        template_version_id = f"/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.Edge/{template_type}/{template_name}/versions/{version}"
        schema_url = template_version_id + "/" + schema_endpoint
        
        try:
            # Make GET request to schema endpoint
            request = client._request("GET", schema_url, {
                "api-version": "2025-08-01"
            }, {
                "Accept": "application/json"
            }, None, {}, None)  # Add missing parameters
            
            response = client.send_request(request=request, stream=False)
            
            if response.http_response.status_code == 404:
                raise CLIInternalError(f"No Editable configs. Schema doesn't exist for template: {template_version_id}")
            elif response.http_response.status_code != 200:
                raise CLIInternalError(f"Failed to get schema for template: {template_version_id}")
            
            import json
            response_text = response.http_response.text()
            data = json.loads(response_text)
            value = data.get("properties", {}).get("value")
            
            if value is None:
                raise CLIInternalError(f"No value field found in schema for template: {template_version_id}")
            
            # Return the raw schema YAML value
            return value
                
        except CLIInternalError:
            # Re-raise CLI errors as-is
            raise
        except Exception as e:
            raise CLIInternalError(f"Error getting schema for template {template_version_id}: {str(e)}")

    # Add your helper methods here


__all__ = ["ConfigurationHelper"]
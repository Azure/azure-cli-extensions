# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

from azure.cli.testsdk import (ScenarioTest, ResourceGroupPreparer)
from azure.cli.testsdk.scenario_tests import AllowLargeResponse

# Tags: Neon PostgreSQL, Organization, Database, Serverless, Managed Service

class NeonScenario(ScenarioTest):
    @AllowLargeResponse(size_kb=10240)
    @ResourceGroupPreparer(name_prefix='cli_test_neon', location="centraluseuap")
    def test_neon(self, resource_group):
        # Test Tags: Organization CRUD, Marketplace Integration, SSO Configuration
        tags_key = 'key'
        tags_val = 'value'
        updated_tags_val = 'value2'
        self.kwargs.update({
            'name': 'Neon-Cli-Scenario-Tests',
            'location': 'centraluseuap',
            'subscription': '00000000-0000-0000-0000-000000000000',
            'marketplace_subscription_id': 'b6ca5a0a-c4be-454f-cc46-a400799b9d49',
            'publisher_id': 'neon1722366567200',
            'offer_id': 'neon_serverless_postgres_azure_prod',
            'plan_id': 'neon_serverless_postgres_azure_prod_free',
            'plan_name': 'Free Plan',
            'term_unit': 'P1M',
            'term_id': 'gmz7xq9ge3py',
            'user_first_name': 'Srinivas',
            'user_last_name': 'Alluri',
            'user_email': 'sralluri211@outlook.com',
            'user_upn': 'sralluri211@outlook.com',
            'user_phone': '+1234567890',
            'company_name': 'SampleCompany',
            'country': 'USA',
            'business_phone': '+1234567890',
            'office_address': '5678 Azure Blvd',
            'domain': 'samplecompany.com',
            'number_of_employees': 500,
            'organization_id': 'org67890',
            'org_name': 'PartnerOrgForCLITest1',
            'enterprise_app_id': 'app67890',
            'sso_url': 'https://sso.partnerorgtest.com',
            'aad_domain': 'partnerorgtest.com',
            'resource_group': 'neonrg',
            'project_name': 'TestProject1',
            'new_project_name': 'TestProject2',
            'pg_version': '17',
            'branch_name': 'main',
            'new_branch_name': 'dev-cli-branch',
            'role_name': 'onwer_role',
            'new_role_name': 'dev_role',
            'database_name': 'neondb',
            'new_database_name': 'clidb',
            'region_id': 'eastus2',
            'storage': 0,
            'history_retention': 0,
            'entity_name': 'Neon-Partner-Demo-project',
            'tags': '{}={}'.format(tags_key, tags_val),
            'updated_tags': '{}={}'.format(tags_key, updated_tags_val),
            'project_id': 'withered-sea-55021972',
            'project_id_to_delete': 'purple-dew-38706216',
            'branch_id': 'br-frosty-bird-a85qx3j8',
            'branch_id_to_delete': 'br-muddy-cherry-a8wbc7ux',
            'org_name': 'Test-Neon-Org-Cli-IT',
            'org_resource_group': 'neonrg',
        })

        # Create Neon Organization
        # Tags: Create, Organization, Marketplace, Complex-Properties
        self.cmd('az neon postgres organization create --resource-group {resource_group} --name {name} --location {location} --tags {tags} --subscription {subscription} '
                 '--marketplace-details \'{{"subscription-id": "{marketplace_subscription_id}", "subscription-status": "PendingFulfillmentStart", '
                 '"offer-details": {{"publisher-id": "{publisher_id}", "offer-id": "{offer_id}", "plan-id": "{plan_id}", "plan-name": "{plan_name}", "term-unit": "{term_unit}", "term-id": "{term_id}"}}}}\' '
                 '--user-details \'{{"first-name": "{user_first_name}", "last-name": "{user_last_name}", "email-address": "{user_email}", "upn": "{user_upn}", "phone-number": "{user_phone}"}}\' '
                 '--company-details \'{{"company-name": "{company_name}", "country": "{country}", "business-phone": "{business_phone}", "office-address": "{office_address}", "domain": "{domain}", "number-of-employees": {number_of_employees}}}\' '
                 '--partner-organization-properties \'{{"organization-name": "{name}", "organization-id": "", '
                 '"single-sign-on-properties": {{"single-sign-on-state": "Enable", "enterprise-app-id": "", "single-sign-on-url": "", "aad-domains": []}}}}\' '
                 '--project-properties \'{{"project-name": "{project_name}", "pg-version": "{pg_version}", '
                 '"region": "{region_id}", '
                 '"branch": {{"branch-name": "{branch_name}", "role-name": "{role_name}", "database-name": "{database_name}"}}}}\'',
                 checks=[
                     self.check('name', '{name}'),
                     self.check('tags.{}'.format(tags_key), tags_val),
                 ])

        # List Neon Organizations
        # Tags: List, Organization, Subscription-Scoped
        self.cmd('az neon postgres organization list --subscription {subscription} --resource-group {resource_group}',
                 checks=[])

        # Show Neon Organization
        # Tags: Show, Organization, Resource-Specific
        self.cmd('az neon postgres organization show --subscription {subscription} --resource-group {resource_group} --name {name}',
                 checks=[
                     self.check('name', '{name}'),
                 ])


         # Create Neon Project with a default branch and database
        self.cmd('az neon postgres project create --resource-group {resource_group} --organization-name {name} '
                 '--project-name {new_project_name} --pg-version {pg_version} --region {region_id} '
                 '--branch "{{\\"branch-name\\":\\"{new_branch_name}\\", \\"role-name\\":\\"{new_role_name}\\", \\"database-name\\":\\"{new_database_name}\\"}}\"')
        

         # List Neon Projects in organization
        self.cmd('az neon postgres project list --resource-group {resource_group} --organization-name {name}',
                 checks=[
                     self.greater_than('length(@)', 0),
                 ])
       
       # Show Neon Project
        self.cmd('az neon postgres project show --resource-group {org_resource_group} --organization-name {org_name} --project-id {project_id}',
                 checks=[
                     self.check('properties.regionId', '{region_id}'),
                 ])
        
         # List branches in the project
        self.cmd('az neon postgres branch list --resource-group {org_resource_group} --organization-name {org_name} --project-id {project_id}',
                 checks=[
                     self.greater_than('length(@)', 0),  # Should have at least 1 branches now
                 ])

        # Create a new branch (dev-branch) off the main branch
        self.cmd('az neon postgres branch create --resource-group {resource_group} --organization-name {org_name} '
                 '--project-name {project_id} --name {new_branch_name} --parent-id {branch_id} '
                 '--role-name {role_name} --database-name {database_name}',
                 checks=[
                     self.check('name', '{new_branch_name}'),
                     self.check('properties.parentId', '{branch_id}'),
                 ])
        
        # List databases in a branch
        self.cmd('az neon postgres neon-database list --resource-group {org_resource_group} --organization-name {org_name} '
                 '--project-id {project_id} --branch-id {branch_id}',
                 checks=[
                     self.greater_than('length(@)', 0)
                 ])
        
         # List roles in a branch
        self.cmd('az neon postgres neon-role list --resource-group {org_resource_group} --organization-name {org_name} '
                 '--project-id {project_id} --branch-id {branch_id}',
                 checks=[
                     self.greater_than('length(@)', 0)
                 ])


        # Delete the branch
        self.cmd('az neon postgres branch delete --resource-group {resource_group} --organization-name {org_name} '
                 '--project-id {project_id_to_delete} --branch-id {branch_id_to_delete} --yes', checks=[])

        # Delete Neon Project
        self.cmd('az neon postgres project delete --resource-group {resource_group} --organization-name {org_name}'
                ' --project-id {project_id_to_delete} --yes', checks=[])

        # Delete Neon Organization
        self.cmd('az neon postgres organization delete --resource-group {resource_group} --name {name} '
                 '--subscription {subscription} --yes',
                 checks=[])

    # NEW TESTS FOR ADDITIONAL COMMANDS ADDED BY BHARGAV

    @AllowLargeResponse(size_kb=10240)
    @ResourceGroupPreparer(name_prefix='cli_test_neon_endpoints', location="centraluseuap")
    def test_neon_endpoint_commands(self, resource_group):
        """Test the new endpoint commands with fixed parameter mapping"""
        self.kwargs.update({
            'resource_group': resource_group,
            'org_name': f'test-endpoint-org-{self.create_random_name("", 8)}',
            'project_name': f'test-endpoint-project-{self.create_random_name("", 8)}',
            'endpoint_name': f'test-endpoint-{self.create_random_name("", 8)}',
            'location': 'centraluseuap',
        })

        # Test endpoint create with fixed parameter mapping (syntax validation)
        try:
            self.cmd('az neon postgres endpoint create --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-name "test-branch-id" --endpoint-name {endpoint_name} '
                     '--endpoint-type "read_only" --no-wait')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping, not actual creation
            # Valid errors: API errors, cassette mismatches, or parent resource not found
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "endpoints limit exceeded", "invalid request", 
                "not found", "cassette", "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

        # Test endpoint list command syntax  
        try:
            self.cmd('az neon postgres endpoint list --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-id "test-branch-id"')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "invalid request", "not found", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

        # Test endpoint delete command syntax
        try:
            self.cmd('az neon postgres endpoint delete --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-name "test-branch-id" --endpoint-name {endpoint_name} --yes')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "not found", "invalid request", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

    @AllowLargeResponse(size_kb=10240)
    @ResourceGroupPreparer(name_prefix='cli_test_neon_databases', location="centraluseuap")
    def test_neon_database_commands(self, resource_group):
        """Test the new database commands with fixed parameter mapping"""
        self.kwargs.update({
            'resource_group': resource_group,
            'org_name': f'test-db-org-{self.create_random_name("", 8)}',
            'database_name': f'test_db_{self.create_random_name("", 8)}',
            'location': 'centraluseuap',
        })

        # Test database create with fixed parameter mapping
        try:
            self.cmd('az neon postgres neon-database create --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-name "test-branch-id" --neon-database-name {database_name} '
                     '--owner-name "test_owner" --no-wait')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "invalid request", "not found", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

        # Test database list command syntax
        try:
            self.cmd('az neon postgres neon-database list --resource-group {resource_group} --organization-name {org_name} '
                     '--project-id "test-project-id" --branch-id "test-branch-id"')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "invalid request", "not found", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

        # Test database delete command syntax
        try:
            self.cmd('az neon postgres neon-database delete --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-name "test-branch-id" --neon-database-name {database_name} --yes')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "not found", "invalid request", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

    @AllowLargeResponse(size_kb=10240)
    @ResourceGroupPreparer(name_prefix='cli_test_neon_roles', location="centraluseuap")
    def test_neon_role_commands(self, resource_group):
        """Test the new role commands with fixed parameter mapping"""
        self.kwargs.update({
            'resource_group': resource_group,
            'org_name': f'test-role-org-{self.create_random_name("", 8)}',
            'role_name': f'test_role_{self.create_random_name("", 8)}',
            'location': 'centraluseuap',
        })

        # Test role create with fixed parameter mapping
        try:
            self.cmd('az neon postgres neon-role create --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-name "test-branch-id" --neon-role-name {role_name} --no-wait')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "invalid request", "not found", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

        # Test role list command syntax
        try:
            self.cmd('az neon postgres neon-role list --resource-group {resource_group} --organization-name {org_name} '
                     '--project-id "test-project-id" --branch-id "test-branch-id"')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "invalid request", "not found", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

        # Test role delete command syntax
        try:
            self.cmd('az neon postgres neon-role delete --resource-group {resource_group} --organization-name {org_name} '
                     '--project-name "test-project-id" --branch-name "test-branch-id" --neon-role-name {role_name} --yes')
        except Exception as e:
            # Expected to fail - we're testing parameter mapping
            error_str = str(e)
            assert any(keyword in error_str for keyword in [
                "ParentResourceNotFound", "not found", "invalid request", "cassette",
                "projects/test-project-id/branches/test-branch-id"
            ]), f"Unexpected error type indicates parameter mapping issue: {e}"

    def test_neon_new_command_help(self):
        """Test help commands for the new commands"""
        new_help_commands = [
            'az neon postgres endpoint --help',
            'az neon postgres endpoint create --help',
            'az neon postgres endpoint list --help', 
            'az neon postgres endpoint delete --help',
            'az neon postgres neon-database --help',
            'az neon postgres neon-database create --help',
            'az neon postgres neon-database list --help',
            'az neon postgres neon-database delete --help',
            'az neon postgres neon-role --help',
            'az neon postgres neon-role create --help',
            'az neon postgres neon-role list --help',
            'az neon postgres neon-role delete --help',
        ]
        
        for help_cmd in new_help_commands:
            # Help commands exit with code 0, so we expect SystemExit
            with self.assertRaises(SystemExit) as cm:
                self.cmd(help_cmd)
            # Ensure it exits with code 0 (success)
            self.assertEqual(cm.exception.code, 0, f"Help command should exit with code 0: {help_cmd}")

    def test_neon_new_command_validation(self):
        """Test command validation for new commands"""
        # Test that required parameters are enforced for new commands
        
        # Test endpoint create without required parameters
        with self.assertRaises(SystemExit):
            self.cmd('az neon postgres endpoint create')
        
        # Test database create without required parameters
        with self.assertRaises(SystemExit):
            self.cmd('az neon postgres neon-database create')
        
        # Test role create without required parameters
        with self.assertRaises(SystemExit):
            self.cmd('az neon postgres neon-role create')
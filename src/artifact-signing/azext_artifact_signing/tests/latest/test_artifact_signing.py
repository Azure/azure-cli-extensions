# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

# Run this test in single test live mode only
# azdev test test_artifact-signing_account --live

import os
from azure.cli.testsdk import *
import json

@live_only()
class ArtifactSigningScenario(ScenarioTest):
    
    @ResourceGroupPreparer(name_prefix= 'cli_test_artifactsign_', location='centraluseuap')
    def test_artifact_signing_account(self, resource_group):
        subscription_id = self.get_subscription_id()
        self.kwargs.update({
            'rg': resource_group, 
            'name': self.create_random_name('acc-cli-', 15),
            'sku': 'Premium',
            'location': 'eastus',
            'tags': 'type=cli op=create',
            'check_name_type': 'Microsoft.CodeSigning/codeSigningAccounts',
            'public_profile_name': self.create_random_name('public-', 15),
            'publictrust_profile_type': 'PublicTrust',
            'public_identity_validation_id': '4931b0b1-c1d4-43a5-800e-259f7937220b',
            'private_profile_name': self.create_random_name('private-', 15),
            'privatetrust_profile_type': 'PrivateTrust',
            'private_identity_validation_id': '072721b8-4e0e-410a-bff9-32b18ed6271c'
        })

        self.cmd('artifact-signing check-name-availability '
                 '--name {name} '
                 '--type {check_name_type}', 
                 checks=[
                        self.check('nameAvailable', True)
        ])

        self.cmd('artifact-signing create '
                 '-g {rg} '
                 '-n {name} ' 
                 '-l {location} '
                 '--sku {sku} '
                 '--tags {tags}', 
                 checks=[
                        self.check('name', '{name}'),
                        self.check('resourceGroup', '{rg}'),
                        self.check('location', '{location}'),
                        self.check('sku.name', 'Premium'),
                        self.check('tags.type', 'cli'),
                        self.check('tags.op', 'create'),
                        self.check('provisioningState', 'Succeeded')
        ])

        self.cmd('artifact-signing update '
                 '-g {rg} '
                 '-n {name} ' 
                 '--sku Basic '
                 '--tags type=cli op=update', 
                 checks=[
                        self.check('name', '{name}'),
                        self.check('resourceGroup', '{rg}'),
                        self.check('location', '{location}'),
                        self.check('sku.name', 'Basic'),
                        self.check('tags.type', 'cli'),
                        self.check('tags.op', 'update'),
                        self.check('provisioningState', 'Succeeded')
        ])

        self.cmd('artifact-signing show '
                 '-g {rg} '
                 '-n {name}', 
                 checks=[
                        self.check('name', '{name}'),
                        self.check('resourceGroup', '{rg}'),
                        self.check('location', '{location}'),
                        self.check('sku.name', 'Basic'),
                         self.check('tags.type', 'cli'),
                        self.check('tags.op', 'update'),
                        self.check('provisioningState', 'Succeeded')
        ])

        self.cmd('artifact-signing certificate-profile create ' 
                 '-g {rg} ' 
                 '--account {name} '
                 '-n {public_profile_name} '
                 '--type {publictrust_profile_type} '
                 '--id {public_identity_validation_id} '
                 '--street true '
                 '--postal-code true',
                 checks=[
                        self.check('name', '{public_profile_name}'),
                        self.check('resourceGroup', '{rg}'),
                        self.check('profileType', '{publictrust_profile_type}'),
                        self.check('identityValidationId', '{public_identity_validation_id}'),
                        self.check('provisioningState', 'Succeeded')
        ])

        self.cmd('artifact-signing certificate-profile create ' 
                 '-g {rg} ' 
                 '--account-name {name} '
                 '-n {private_profile_name} '
                 '--profile-type {privatetrust_profile_type} '
                 '--id {private_identity_validation_id} '
                 '--include-street true '
                 '--include-postal-code true',
                 checks=[
                        self.check('name', '{private_profile_name}'),
                        self.check('resourceGroup', '{rg}'),
                        self.check('profileType', '{privatetrust_profile_type}'),
                        self.check('identityValidationId', '{private_identity_validation_id}'),
                        self.check('provisioningState', 'Succeeded')
        ])

        self.cmd('artifact-signing certificate-profile delete '
                 '-g {rg} '
                 '--account-name {name} '
                 '-n {private_profile_name} -y')
        
        profilesList = self.cmd('artifact-signing certificate-profile list '
                                '-g {rg} '
                                '--account-name {name}').get_output_in_json()
        
        assert len(profilesList) == 1 

        self.cmd('artifact-signing delete -g {rg} -n {name} -y')

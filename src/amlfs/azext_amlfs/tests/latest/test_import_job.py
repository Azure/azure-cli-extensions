# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

import time
from azure.cli.testsdk import *

class AmlfsImportJobScenario(ScenarioTest):
    def _wait_for_import_job_completion(self, amlfs_name, import_job_name, max_attempts=60):
        """Helper method to poll for import job completion."""
        terminal_states = ['Completed', 'Failed', 'Cancelled']
        for attempt in range(max_attempts):
            result = self.cmd(f'amlfs import show -g {{rg}} --aml-filesystem-name {amlfs_name} --import-job-name {import_job_name}').get_output_in_json()
            if result.get('properties', {}).get('state') in terminal_states:
                break
            time.sleep(5)
    
    def _wait_for_import_job_deletion(self, amlfs_name, import_job_name, max_attempts=60):
        """Helper method to poll for import job deletion by checking if it's no longer in the list."""
        for attempt in range(max_attempts):
            result = self.cmd(f'amlfs import list -g {{rg}} --aml-filesystem-name {amlfs_name}').get_output_in_json()
            # Check if the import job name is not in the list of jobs
            job_names = [job.get('name', '') for job in result]
            if import_job_name not in job_names:
                break
            time.sleep(5)

    def _get_storage_account_id(self, resource_group, storage_account_name):
        """Helper method to get storage account resource ID"""
        return f"/subscriptions/{self.get_subscription_id()}/resourceGroups/{resource_group}/providers/Microsoft.Storage/storageAccounts/{storage_account_name}"

    def _get_container_id(self, resource_group, storage_account_name, container_name):
        """Helper method to get container resource ID"""
        return f"/subscriptions/{self.get_subscription_id()}/resourceGroups/{resource_group}/providers/Microsoft.Storage/storageAccounts/{storage_account_name}/blobServices/default/containers/{container_name}"
    
    @ResourceGroupPreparer(location='canadacentral')
    @StorageAccountPreparer(name_prefix='amlfsimportsa', kind='StorageV2', location='canadacentral')
    def test_import_job_crud(self, resource_group, storage_account):
        """Test the full CRUD operations for AMLFS import jobs with HSM settings."""
        self.kwargs.update({
            'vnet': self.create_random_name('vnet', 10),
            'subnet': self.create_random_name('subnet', 15),
            'amlfs': self.create_random_name('sys', 10),
            'import_job': self.create_random_name('job', 10),
            'storage_account': storage_account,
            'import_container': self.create_random_name('import', 15),
            'logging_container': self.create_random_name('logging', 15)
        })
        # Create prerequisites: identity, network
        self.cmd('az network vnet create -n {vnet} -g {rg} --address-prefix 20.0.0.0/24')
        subnet_id = self.cmd('az network vnet subnet create -n {subnet} -g {rg} --address-prefix 20.0.0.0/24 --vnet-name {vnet} ').get_output_in_json()['id']

        self.kwargs.update({
            'subnet_id': subnet_id
        })

        # Configure storage account with shared key access enabled (required for HSM settings)
        self.cmd('az storage account update --name {storage_account} --resource-group {rg} --allow-shared-key-access true')

        # Get storage account connection string
        connection_string_result = self.cmd('az storage account show-connection-string --name {storage_account} --resource-group {rg}').get_output_in_json()
        self.kwargs['connection_string'] = connection_string_result['connectionString']

        # Create containers for HSM settings
        self.cmd('az storage container create --name {import_container} --connection-string "{connection_string}"')
        self.cmd('az storage container create --name {logging_container} --connection-string "{connection_string}"')

        # Get container resource IDs for HSM settings
        import_container_id = self._get_container_id(resource_group, storage_account, self.kwargs['import_container'])
        logging_container_id = self._get_container_id(resource_group, storage_account, self.kwargs['logging_container'])
        self.kwargs.update({
            'import_container_id': import_container_id,
            'logging_container_id': logging_container_id
        })
        
        # Create AMLFS with HSM settings
        self.cmd('az amlfs create '
                 '--name {amlfs} '
                 '--resource-group {rg} '
                 '--sku AMLFS-Durable-Premium-250 '
                 '--storage-capacity 16 '
                 '--zones 1 '
                 '--maintenance-window dayOfWeek=friday timeOfDayUtc=22:00 '
                 '--filesystem-subnet {subnet_id} '
                 '--hsm-settings container="{import_container_id}" '
                 'logging-container="{logging_container_id}" '
                 'import-prefix="/"')
        
        # Wait for AMLFS to be ready
        self.cmd('az amlfs wait --name {amlfs} --resource-group {rg} --created --timeout 1800')

        current_import_job_count = len(self.cmd('az amlfs import list -g {rg} --aml-filesystem-name {amlfs}').get_output_in_json())
        self.kwargs['current_import_job_count'] = current_import_job_count

        # Test import job create
        self.cmd('az amlfs import create -g {rg} --aml-filesystem-name {amlfs} --import-job-name {import_job} --location canadacentral --import-prefixes "[/]" --conflict-resolution-mode OverwriteAlways --maximum-errors 0', checks=[
            self.check('name', '{import_job}'),
            self.check('location', 'canadacentral'),
            self.check('importPrefixes', ['/']),
            self.check('conflictResolutionMode', 'OverwriteAlways'),
            self.check('maximumErrors', 0),
            self.check('adminStatus', 'Active')
        ])
        current_import_job_count += 1
        self.kwargs['current_import_job_count'] = current_import_job_count

        # Test import job show
        self.cmd('az amlfs import show -g {rg} --aml-filesystem-name {amlfs} --import-job-name {import_job}', checks=[
            self.check('name', '{import_job}'),
            self.check('location', 'canadacentral'),
            self.check('importPrefixes', ['/']),
            self.check('conflictResolutionMode', 'OverwriteAlways'),
            self.check('maximumErrors', 0)
        ])
        
        # Test import job list
        self.cmd('az amlfs import list -g {rg} --aml-filesystem-name {amlfs}', checks=[
            self.check('length(@)', current_import_job_count),
            self.check('[0].name', 'importJobInitialAmlfsPut'),
            self.check('[0].location', 'canadacentral')
        ])
        
        # Test import job update (cancel the job)
        # Note: The import job must be in a state that allows cancellation or other operations (e.g., Active)
        # self.cmd('az amlfs import update -g {rg} --aml-filesystem-name {amlfs} --import-job-name {import_job} --admin-status Cancel', checks=[
        #     self.check('name', '{import_job}'),
        #     self.check('properties.adminStatus', 'Cancel')
        # ])

        # Poll for the job to complete
        self._wait_for_import_job_completion('{amlfs}', '{import_job}')
        
        # Test import job delete
        self.cmd('az amlfs import delete -g {rg} --aml-filesystem-name {amlfs} --import-job-name {import_job} -y')
        self._wait_for_import_job_deletion('{amlfs}', '{import_job}')
        
        # Cleanup AMLFS
        self.cmd('az amlfs delete -n {amlfs} -g {rg} -y')

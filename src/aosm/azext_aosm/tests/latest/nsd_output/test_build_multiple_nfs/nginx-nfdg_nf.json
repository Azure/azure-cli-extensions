{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.8.9.13224",
      "templateHash": "7785776639150561987"
    }
  },
  "parameters": {
    "publisherName": {
      "type": "string",
      "defaultValue": "reference-publisher",
      "metadata": {
        "description": "Publisher where the NFD is published"
      }
    },
    "networkFunctionDefinitionGroupName": {
      "type": "string",
      "defaultValue": "nginx-nfdg",
      "metadata": {
        "description": "NFD Group name for the Network Function"
      }
    },
    "nginx_nfdg_nfd_version": {
      "type": "string",
      "metadata": {
        "description": "NFD version"
      }
    },
    "networkFunctionDefinitionOfferingLocation": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Offering location for the Network Function"
      }
    },
    "managedIdentity": {
      "type": "string",
      "metadata": {
        "description": "The managed identity that should be used to create the NF."
      }
    },
    "customLocationId": {
      "type": "string",
      "metadata": {
        "description": "The custom location of the ARC-enabled AKS cluster to create the NF."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "nfviType": {
      "type": "string",
      "defaultValue": "AzureArcKubernetes"
    },
    "resourceGroupId": {
      "type": "string",
      "defaultValue": "[resourceGroup().id]"
    },
    "deploymentParameters": {
      "type": "array"
    }
  },
  "variables": {
    "identityObject": "[if(equals(parameters('managedIdentity'), ''), createObject('type', 'SystemAssigned'), createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', parameters('managedIdentity')), createObject())))]"
  },
  "resources": [
    {
      "copy": {
        "name": "nf_resource",
        "count": "[length(parameters('deploymentParameters'))]"
      },
      "type": "Microsoft.HybridNetwork/networkFunctions",
      "apiVersion": "2023-04-01-preview",
      "name": "[format('nginx-nfdg{0}', copyIndex())]",
      "location": "[parameters('location')]",
      "identity": "[variables('identityObject')]",
      "properties": {
        "publisherName": "[parameters('publisherName')]",
        "publisherScope": "Private",
        "networkFunctionDefinitionGroupName": "[parameters('networkFunctionDefinitionGroupName')]",
        "networkFunctionDefinitionVersion": "[parameters('nginx_nfdg_nfd_version')]",
        "networkFunctionDefinitionOfferingLocation": "[parameters('networkFunctionDefinitionOfferingLocation')]",
        "nfviType": "[parameters('nfviType')]",
        "nfviId": "[parameters('customLocationId')]",
        "allowSoftwareUpdate": true,
        "deploymentValues": "[string(parameters('deploymentParameters')[copyIndex()])]"
      }
    }
  ]
}
# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------
# The @ResourceGroupPreparer decorator is used to automatically create and manage a resource group for the duration of the test.
# It ensures that the resource group is created before the test runs and deleted after the test completes, regardless of whether
# the test passes or fails. This helps to keep the Azure environment clean and prevents resource leaks.
# --------------------------------------------------------------------------------------------

import random
import string
from azure.cli.testsdk import ScenarioTest, ResourceGroupPreparer

def create_valid_random_name(prefix, length):
    """Generate a random name that matches the required pattern."""
    if len(prefix) > length:
        raise ValueError('The length of the prefix must not be longer than random name length')
    
    padding_size = length - len(prefix)
    if padding_size < 4:
        raise ValueError('The randomized part of the name is shorter than 4, which may not be able to offer enough randomness')
    
    random_part = ''.join(random.choices(string.ascii_lowercase + string.digits, k=padding_size))
    return prefix + random_part

class DeidserviceScenario(ScenarioTest):
    
    @ResourceGroupPreparer(name_prefix='test_deidservice_', location='eastus')
    def test_deidservice_lifecycle(self, resource_group):

        # Set a fixed seed for random data
        # This ensures that the test will be deterministic and VCR will record and playback the same data
        random.seed(42)
        
        self.kwargs.update({
            'deidservice': create_valid_random_name('deidservice-', 24),
            'location': 'eastus',
            'rg': resource_group
        })
        
        # Create deidservice
        self.cmd('az deidservice create --name {deidservice} -g {rg} --location {location}', checks=[
            self.check('name', '{deidservice}'),
            self.check('location', '{location}')
        ])
        
        # Update deidservice
        self.cmd('az deidservice update --name {deidservice} -g {rg} --tags tag=test', checks=[
            self.check('name', '{deidservice}'),
            self.check('tags.tag', 'test')
        ])
        
        # Show deidservice
        self.cmd('az deidservice show --name {deidservice} -g {rg}', checks=[
            self.check('name', '{deidservice}'),
            self.check('tags.tag', 'test'),
            self.check('location', '{location}'),
            self.check('resourceGroup', '{rg}'),
            self.check('type', 'microsoft.healthdataaiservices/deidservices')
        ])
        
        # List deidservices
        self.cmd('az deidservice list -g {rg}', checks=[
            self.check('[0].name', '{deidservice}'),
            self.check('[0].tags.tag', 'test'),
            self.check('[0].location', '{location}'),
            self.check('[0].resourceGroup', '{rg}'),
            self.check('[0].type', 'microsoft.healthdataaiservices/deidservices')
        ])
        
        # Delete deidservice
        self.cmd('az deidservice delete --name {deidservice} -g {rg} -y')
        
        # Verify deletion by listing again
        services = self.cmd('az deidservice list -g {rg}').get_output_in_json()
        self.assertEqual(len(services), 0)
# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

from azure.cli.testsdk import *


class StorageActionsScenario(ScenarioTest):
    @ResourceGroupPreparer(location='eastus2')
    def test_storage_actions_task_scenarios(self):
        self.kwargs.update({
            "task_name": self.create_random_name('satasks', 18)
        })
        self.cmd("az storage-actions task create -g {rg} -n {task_name} --identity {{type:SystemAssigned}} "
                 "--tags {{key1:value1}} --action {{if:{{condition:\\'[[equals(AccessTier,\\'/Cool\\'/)]]\\',"
                 "operations:[{{name:'SetBlobTier',parameters:{{tier:'Hot'}},"
                 "onSuccess:'continue',onFailure:'break'}}]}},"
                 "else:{{operations:[{{name:'DeleteBlob',onSuccess:'continue',onFailure:'break'}}]}}}} "
                 "--description StorageTask1 --enabled true")
        self.cmd('az storage-actions task show -g {rg} -n {task_name}',
                 checks=[JMESPathCheck('name', self.kwargs.get('task_name', '')),
                         JMESPathCheck('location', "eastus2"),
                         # service regression
                         # JMESPathCheck('tags', {"key1": "value1"}),
                         JMESPathCheck('description', "StorageTask1"),
                         JMESPathCheck('action.if.condition', "[[equals(AccessTier,'Cool')]]"),
                         JMESPathCheck('action.if.operations[0].name', "SetBlobTier"),
                         JMESPathCheck('action.if.operations[0].onSuccess', "continue"),
                         JMESPathCheck('action.if.operations[0].onFailure', "break"),
                         JMESPathCheck('action.if.operations[0].parameters', {"tier": "Hot"}),
                         JMESPathCheck('action.else.operations[0].name', "DeleteBlob"),
                         JMESPathCheck('action.else.operations[0].onSuccess', "continue"),
                         JMESPathCheck('action.else.operations[0].onFailure', "break")])
        self.cmd('az storage-actions task list-assignment -g {rg} -n {task_name}')
        self.cmd('az storage-actions task list-report -g {rg} -n {task_name}')
        self.cmd('az storage-actions task list -g {rg}', checks=[JMESPathCheck('length(@)', 1)])
        self.cmd("az storage-actions task update -g {rg} -n {task_name} --identity {{type:SystemAssigned}} "
                 "--tags {{key2:value2}} --action {{if:{{condition:\\'[[equals(BlobType,\\'/BlockBlob\\'/)]]\\',"
                 "operations:[{{name:'SetBlobTags',parameters:{{Archive-Status:'Archived'}},"
                 "onSuccess:'continue',onFailure:'break'}}]}},"
                 "else:{{operations:[{{name:'UndeleteBlob',onSuccess:'continue',onFailure:'break'}}]}}}} "
                 "--description StorageTask1Update --enabled true",
                 checks=[JMESPathCheck('description', "StorageTask1Update"),
                         # service regression
                         # JMESPathCheck('tags', {"key2": "value2"}),
                         JMESPathCheck('action.if.condition', "[[equals(BlobType,'BlockBlob')]]"),
                         JMESPathCheck('action.if.operations[0].name', "SetBlobTags"),
                         JMESPathCheck('action.if.operations[0].onSuccess', "continue"),
                         JMESPathCheck('action.if.operations[0].onFailure', "break"),
                         JMESPathCheck('action.if.operations[0].parameters', {"Archive-Status":"Archived"}),
                         JMESPathCheck('action.else.operations[0].name', "UndeleteBlob"),
                         JMESPathCheck('action.else.operations[0].onSuccess', "continue"),
                         JMESPathCheck('action.else.operations[0].onFailure', "break")])
        self.cmd('az storage-actions task delete -g {rg} -n {task_name} -y')
        self.cmd('az storage-actions task list -g {rg}', checks=[JMESPathCheck('length(@)', 0)])

    def test_storage_actions_task_preview_action_scenarios(self):
        self.cmd("az storage-actions task preview-action -l eastus2 "
                 "--action {{if:{{condition:\\'[[equals(AccessTier,\\'/Hot\\'/)]]\\'}},else-block-exists:True}} "
                 "--blobs [{{name:'folder1/file1.txt',"
                 "properties:[{{key:'Creation-Time',value:\\''Wed, 07 Jun 2023 05:23:29 GMT'\\'}},"
                 "{{key:'Last-Modified',value:\\''Wed, 07 Jun 2023 05:23:29 GMT'\\'}},"
                 "{{key:'Etag',value:'0x8DB67175454D36D'}},"
                 "{{key:'Content-Length',value:'38619'}},"
                 "{{key:'Content-Type',value:'text/xml'}},"
                 "{{key:'Content-Encoding',value:\\'''\\'}},"
                 "{{key:'Content-Language',value:\\'''\\'}},"
                 "{{key:'Content-CRC64',value:\\'''\\'}},"
                 "{{key:'Content-MD5',value:'njr6iDrmU9+FC89WMK22EA=='}},"
                 "{{key:'Cache-Control',value:\\'''\\'}},"
                 "{{key:'Content-Disposition',value:\\'''\\'}},"
                 "{{key:'BlobType',value:'BlockBlob'}},"
                 "{{key:'AccessTier',value:'Hot'}},"
                 "{{key:'AccessTierInferred',value:'true'}},"
                 "{{key:'LeaseStatus',value:'unlocked'}},"
                 "{{key:'LeaseState',value:'available'}},"
                 "{{key:'ServerEncrypted',value:'true'}},"
                 "{{key:'TagCount',value:'1'}}],"
                 "metadata:[{{key:'mKey1',value:'mValue1'}}],"
                 "tags:[{{key:'tKey1',value:'tValue1'}}]}},"
                 "{{name:'folder2/file1.txt',"
                 "properties:[{{key:'Creation-Time',value:\\''Wed, 06 Jun 2023 05:23:29 GMT'\\'}},"
                 "{{key:'Last-Modified',value:\\''Wed, 06 Jun 2023 05:23:29 GMT'\\'}},"
                 "{{key:'Etag',value:'0x6FB67175454D36D'}}],"
                 "metadata:[{{key:'mKey2',value:'mValue2'}}],"
                 "tags:[{{key:'tKey2',value:'tValue2'}}]}}] "
                 "--container {{name:'firstContainer',metadata:[{{key:'mContainerKey1',value:'mContainerValue1'}}]}}",
                 checks=[JMESPathCheck('blobs[0].matchedBlock', "If"),
                         JMESPathCheck('blobs[1].matchedBlock', "Else"),])

# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

import os
import unittest
from azure.cli.testsdk import *


class DellScenario(ScenarioTest):
    """Test scenarios for Dell.Storage CLI extension.

    This test suite covers all Dell filesystem operations including:
    - Help commands
    - Create operations (with SkipProvision tag)
    - List operations
    - Show operations
    - Delete operations
    """

    def test_dell_filesystem_help_commands(self):
        """Test Dell filesystem help commands work correctly"""
        # Test help commands that don't require live resources
        try:
            self.cmd('az dell -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem create -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem list -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem show -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem delete -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem wait -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

    @unittest.skipIf(not os.environ.get('AZURE_TEST_RUN_LIVE'), 'Live mode only test')
    @ResourceGroupPreparer(name_prefix='cli_test_dell')
    def test_dell_filesystem_create_filesystem(self, resource_group):
        """Test Dell filesystem create command with SkipProvision tag.

        This test validates the create operation with DEPLOYMENT_MODE=SkipProvision
        tag to ensure proper request formatting without actual resource creation.
        """

        filesystem_name = self.create_random_name('mydellfs', 20)

        # Test create command with DEPLOYMENT_MODE=SkipProvision
        # Note: This may result in validation errors but still tests the command structure
        try:
            result = self.cmd('az dell filesystem create '
                              '--resource-group {rg} '
                              '--filesystem-name ' + filesystem_name + ' '
                              '--location "East US" '
                              '--delegated-subnet-id "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/{rg}/providers/Microsoft.Network/virtualNetworks/test-vnet/subnets/test-subnet" '
                              '--delegated-subnet-cidr "10.0.1.0/24" '
                              '--marketplace \'{{"marketplace-subscription-id":"test-sub-123","plan-id":"basic-plan","offer-id":"dell-storage-offer","publisher-id":"dell-tech","plan-name":"Basic Dell Plan"}}\' '
                              '--user \'{{"email":"admin@test.com"}}\' '
                              '--smart-connect-fqdn "' + filesystem_name + '.test.com" '
                              '--one-fs-url "https://' + filesystem_name + '.onefs.test.com" '
                              '--dell-reference-number "DELL-TEST-001" '
                              '--encryption \'{{"encryption-type":"Microsoft-managed keys (MMK)"}}\' '
                              '--tags \'{{"Environment":"Development","Owner":"TestTeam","DEPLOYMENT_MODE":"SkipProvision"}}\' ')
        except Exception:
            # Expected to fail with validation errors but should create a valid recording
            pass

    @unittest.skipIf(not os.environ.get('AZURE_TEST_RUN_LIVE'), 'Live mode only test')
    @ResourceGroupPreparer(name_prefix='cli_test_dell')
    def test_dell_filesystem_list_operations(self, resource_group):
        """Test Dell filesystem list command returns proper JSON structure."""

        # Test list command - should return a list (empty or with filesystems)
        result = self.cmd(
            'az dell filesystem list --resource-group {rg}').get_output_in_json()
        self.assertIsInstance(result, list)

    @unittest.skipIf(not os.environ.get('AZURE_TEST_RUN_LIVE'), 'Live mode only test')
    def test_dell_filesystem_show_existing(self):
        """Test Dell filesystem show command with existing resource.

        Tests the show operation against a known existing Dell filesystem
        to validate the command structure and response format.
        """

        # Test show command with specific existing filesystem
        # Resource: /subscriptions/b9aad304-baa9-4d2a-9404-dbdd3ab55ac5/resourceGroups/praveensingh-test/providers/Dell.Storage/filesystems/cliuksouth-1
        subscription_id = "b9aad304-baa9-4d2a-9404-dbdd3ab55ac5"
        resource_group = "praveensingh-test"
        filesystem_name = "cliuksouth-1"

        self.cmd('az dell filesystem show '
                 f'--subscription {subscription_id} '
                 f'--resource-group {resource_group} '
                 f'--filesystem-name {filesystem_name}',
                 checks=[
                     self.check('name', filesystem_name),
                     self.check('resourceGroup', resource_group),
                     self.exists('id'),
                     self.exists('properties')
                 ])

    @unittest.skipIf(not os.environ.get('AZURE_TEST_RUN_LIVE'), 'Live mode only test')
    def test_dell_filesystem_delete_operations(self):
        """Test Dell filesystem delete command with existing resource.

        Tests the delete operation against a specific Dell filesystem
        to validate synchronous deletion operation.
        """

        # Test delete command on existing resource
        # Resource: /subscriptions/b9aad304-baa9-4d2a-9404-dbdd3ab55ac5/resourceGroups/praveensingh-test/providers/Dell.Storage/filesystems/cliSCUS-1
        self.cmd('az dell filesystem delete '
                 '--resource-group praveensingh-test '
                 '--filesystem-name cliSCUS-1 '
                 '--subscription b9aad304-baa9-4d2a-9404-dbdd3ab55ac5 '
                 '--yes')

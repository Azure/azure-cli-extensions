# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
#
# Code generated by aaz-dev-tools
# --------------------------------------------------------------------------------------------

import os
import unittest
from azure.cli.testsdk import *


class DellScenario(ScenarioTest):
    # TODO: add tests here
    """Test scenarios for Dell.Storage CLI extension.

    This test suite covers all Dell filesystem operations including:
    - Help commands
    - Create operations (with SkipProvision tag)
    - List operations
    - Show operations
    - Delete operations
    """

    def test_dell_filesystem_help_commands(self):
        """Test Dell filesystem help commands work correctly"""
        # Test help commands that don't require live resources
        try:
            self.cmd('az dell -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem create -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem list -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem show -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem delete -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

        try:
            self.cmd('az dell filesystem wait -h')
        except SystemExit as e:
            self.assertEqual(
                e.code, 0, "Help command should exit successfully")

    @ResourceGroupPreparer(name_prefix='cli_test_dell')
    def test_dell_filesystem_create(self, resource_group):
        """Test Dell filesystem create command.

        This test validates the CLI functionality with proper data structure,
        using SkipProvision to avoid creating actual resources.
        """
        subscription_id = self.get_subscription_id()
        filesystem_name = self.create_random_name('dellfs', 15)

        # Use sanitized test data
        delegated_subnet_id = f"/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.Network/virtualNetworks/test-vnet-eastus/subnets/default"

        # Test create command - expect validation failure with proper error handling
        with self.assertRaises(Exception) as context:
            self.cmd('az dell filesystem create '
                     '--resource-group {rg} '
                     '--filesystem-name ' + filesystem_name + ' '
                     '--location "East US" '
                     '--delegated-subnet-id "' + delegated_subnet_id + '" '
                     '--delegated-subnet-cidr "10.0.0.0/24" '
                     '--marketplace \'{{"marketplace-subscription-id":"00000000-0000-0000-0000-000000000000","plan-id":"testplan","offer-id":"thunderscaletest","publisher-id":"dellemc","plan-name":"Premium","end-date":"06/23/2026 00:00:00","term-unit":"P1Y"}}\' '
                     '--user \'{{"email":"user@example.com"}}\' '
                     '--dell-reference-number "100438419" '
                     '--encryption \'{{"encryption-type":"Microsoft-managed keys (MMK)"}}\' '
                     '--tags \'{{"DEPLOYMENT_MODE":"SkipProvision"}}\' ')

        # Validate that we get expected validation errors (not generic failures)
        error_message = str(context.exception)
        self.assertIn("ResourceCreationValidateFailed", error_message)

    @ResourceGroupPreparer(name_prefix='cli_test_dell')
    def test_dell_filesystem_list_operations(self, resource_group):
        """Test Dell filesystem list command returns proper JSON structure."""

        # Test list command - should return a list (empty or with filesystems)
        result = self.cmd(
            'az dell filesystem list --resource-group {rg}').get_output_in_json()

        # Validate response structure
        self.assertIsInstance(result, list)
        # In a clean test environment, list should be empty
        self.assertEqual(len(result), 0)

    def test_dell_filesystem_show_existing(self):
        """Test Dell filesystem show command with existing resource.

        Tests the show operation against a known existing Dell filesystem
        to validate the command structure and response format.
        """
        # Use sanitized test data that matches the recording
        subscription_id = "00000000-0000-0000-0000-000000000000"
        resource_group = "praveensingh-test"
        filesystem_name = "cliuksouth-1"

        # This test uses the recording which has a successful response
        result = self.cmd('az dell filesystem show '
                          f'--subscription {subscription_id} '
                          f'--resource-group {resource_group} '
                          f'--filesystem-name {filesystem_name}')

        # Validate that we get a proper JSON response with expected fields
        output = result.get_output_in_json()
        self.assertIn('name', output)
        self.assertIn('id', output)
        self.assertIn('properties', output)
        self.assertEqual(output['name'], filesystem_name)

    def test_dell_filesystem_delete_operations(self):
        """Test Dell filesystem delete command behavior.

        Tests the delete operation to validate command structure and error handling.
        """
        # Use sanitized test data that matches the recording
        subscription_id = "00000000-0000-0000-0000-000000000000"
        resource_group = "praveensingh-test"
        filesystem_name = "nonexistent-filesystem"

        # Test delete command on a resource that doesn't exist - should handle gracefully
        result = self.cmd('az dell filesystem delete '
                          f'--resource-group {resource_group} '
                          f'--filesystem-name {filesystem_name} '
                          f'--subscription {subscription_id} '
                          '--yes')

        # Delete should succeed (204 No Content) even if resource doesn't exist
        self.assertEqual(result.exit_code, 0)

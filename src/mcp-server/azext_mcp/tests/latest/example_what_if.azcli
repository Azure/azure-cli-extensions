#!/bin/bash
# Initialize variables with random identifiers to avoid conflicts
location="eastus"
resourceGroup="azcli-script-insight"
vmName="demo-vm-123"
storageAccount="stgaccount123"
sqlServer="sql-server-123"
sqlDB="appdb-123"
adminUser="azureadmin"
password="P@ssw0rd-123"  # Use Key Vault for production!

### 1. Create Resource Group
az group create --name $resourceGroup --location $location \
    --tags "Env=Demoscript" "Purpose=CLIExample" [6,8](@ref)

### 2. Create Virtual Machine (Ubuntu)
az vm create --resource-group $resourceGroup --name $vmName \
    --image Ubuntu2204 --admin-username $adminUser \
    --generate-ssh-keys --public-ip-sku Standard \
    --size Standard_B2s --custom-data cloud-init.txt [7,8](@ref) --nsg-rule None

### 3. Create Storage Account
az storage account create --name $storageAccount \
    --resource-group $resourceGroup --location $location \
    --sku Standard_LRS --encryption-services blob [8,5](@ref) --allow-shared-key-access false 

### 4. Create SQL Database Server
az sql server create --name $sqlServer --resource-group $resourceGroup \
    --location $location --admin-user $adminUser \
    --admin-password $password [9](@ref)

### 5. Configure SQL Firewall (Allow Azure Services)
az sql server firewall-rule create --resource-group $resourceGroup \
    --server $sqlServer --name "AllowAzure" \
    --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0 [9](@ref)

### 6. Create Database
az sql db create --name $sqlDB --resource-group $resourceGroup \
    --server $sqlServer --edition GeneralPurpose \
    --family Gen5 --capacity 2 [9](@ref)

### 7. Update VM Size (Scale Up)
az vm resize --resource-group $resourceGroup --name $vmName \
    --size Standard_B4ms [7,8](@ref)

### 8. Update Database Tier (Scale Up)
az sql db update --name $sqlDB --resource-group $resourceGroup \
    --server $sqlServer --capacity 4 [9](@ref)

### 9. Monitor Resources
echo "--- Virtual Machine State ---"
az vm show --resource-group $resourceGroup --name $vmName \
    --query "{Name:name, Status:powerState, IP:publicIps}" --output table [7](@ref)

echo "--- Database Size ---"
az sql db list-usages --name $sqlDB --resource-group "azcli-script-insight" \
    --server $sqlServer --query "[].{Metric:displayName, Limit:limit}" --output table [9](@ref)